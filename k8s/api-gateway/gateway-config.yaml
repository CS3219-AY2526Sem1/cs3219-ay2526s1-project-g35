apiVersion: v1
kind: ConfigMap
metadata:
  name: peerprep-gateway-config
  namespace: peerprep-gateway
data:
  kong.yml: |
    _format_version: "3.0"
    
    services:
    # User Service - Users Routes
    - name: user-service-users
      url: http://user-service.peerprep.svc.cluster.local:8000/users
      routes:
      - name: user-routes
        paths:
        - /api/users
        strip_path: true
        methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
    
    # User Service - Auth Routes
    - name: user-service-auth
      url: http://user-service.peerprep.svc.cluster.local:8000/auth
      routes:
      - name: auth-routes
        paths:
        - /api/auth
        strip_path: true
        methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
    
    # Question Service
    - name: question-service
      url: http://question-service.peerprep.svc.cluster.local:8001
      routes:
      - name: question-routes
        paths:
        - /api/questions
        strip_path: true
        methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
    
    # Collaboration Service (supports WebSocket upgrade)
    - name: collaboration-service
      url: http://collaboration-service.peerprep.svc.cluster.local:8002
      routes:
      - name: collaboration-routes
        paths:
        - /api/collaboration
        strip_path: true
        protocols:
        - http
        - https
        methods:
        - GET
        - POST
        - OPTIONS
    
    # Matching Service (HTTP endpoints only, not direct WebSocket)
    - name: matching-service-http
      url: http://matching-service.peerprep.svc.cluster.local:8003
      routes:
      - name: matching-http-routes
        paths:
        - /api/matching
        strip_path: true
        methods:
        - GET
        - POST
        - OPTIONS
    
    # Global plugins
    plugins:
    - name: cors
      config:
        origins:
        - "http://34.36.96.229"
        - "http://localhost:3000"
        - "http://127.0.0.1:3000"
        methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Auth-Token
        - Cookie
        exposed_headers:
        - X-Auth-Token
        - Set-Cookie
        credentials: true
        max_age: 3600
    
    - name: rate-limiting
      config:
        minute: 1000
        hour: 10000
        policy: local
