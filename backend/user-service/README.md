# CS3219 project: PeerPrep

## User Service

The User Service handles user registration, authentication, and email verification using OTP (One-Time Password) for enhanced security.

### Key Features
- User registration and authentication
- Email verification with OTP system
- JWT-based session management with Redis token whitelisting
- Role-based access control (admin/user)
- Rate limiting for authentication attempts
- Secure password hashing with Argon2id

### Quick Start

1. In the `user-service` directory, create a copy of the `.env.sample` file and name it `.env`.
2. Create a MongoDB Atlas Cluster and obtain the connection string.
3. Add the connection string to the `.env` file under the variable `DB_CLOUD_URI`.
4. Ensure you are in the `user-service` directory, then install project dependencies with `npm install`.
5. Start the User Service with `npm start` or `npm run dev`.
6. If the server starts successfully, you will see a "User service server listening on ..." message.

### Complete User Service Guide: [User Service Guide](./user-service/README.md)


# User Service Guide


## Running User Service

### Local Development

1. Open Command Line/Terminal and navigate into the `user-service` directory.

2. Run the command: `npm install`. This will install all the necessary dependencies.

3. Run the command `npm start` to start the User Service in production mode, or use `npm run dev` for development mode, which includes features like automatic server restart when you make code changes.

4. Using applications like Postman, you can interact with the User Service on port 3001. If you wish to change this, please update the `.env` file.

### Docker Setup

1. Ensure you have Docker and Docker Compose installed on your system.

2. In the `user-service` directory, create a copy of the `.env.docker` file if it doesn't exist and configure your environment variables.

3. Build and start the User Service with Docker Compose:
   ```bash
   docker-compose --env-file .env.docker up --build
   ```

4. The service will be available on port 3001. To stop the containers:
   ```bash
   docker-compose down
   ```

Note: The Docker setup includes Redis for token whitelisting and uses the environment variables from `.env.docker`.

## User Service API Guide

### Create User

- This endpoint allows adding a new user to the database (i.e., user registration).
- **Note**: Newly registered users must verify their email address using OTP before gaining full access to protected features.

- HTTP Method: `POST`

- Endpoint: http://localhost:3001/users

- Body
  - Required: `username` (string), `email` (string), `password` (string)

    ```json
    {
      "username": "SampleUserName",
      "email": "sample@gmail.com",
      "password": "SecurePassword"
    }
    ```

- Responses:

    | Response Code               | Explanation                                           |
    |-----------------------------|-------------------------------------------------------|
    | 201 (Created)               | User created successfully, created user data returned. **Note**: User must verify email before accessing protected features. |
    | 400 (Bad Request)           | Missing fields                                        |
    | 409 (Conflict)              | Duplicate username or email encountered               |
    | 500 (Internal Server Error) | Database or server error                              |

### Get User ID by Username

- This endpoint allows retrieval of a user's ID using their username. This is a public endpoint that does not require authentication.

- HTTP Method: `GET`

- Endpoint: http://localhost:3001/users/username/{username}

- Parameters
    - Required: `username` path parameter
    - Example: `http://localhost:3001/users/username/johndoe`

- Authentication
    - Not required (public endpoint)

- Responses:

    | Response Code               | Explanation                                              |
    |-----------------------------|----------------------------------------------------------|
    | 200 (OK)                    | Success, user ID and username returned                   |
    | 400 (Bad Request)           | Missing username parameter                               |
    | 404 (Not Found)             | User with the specified username not found               |
    | 500 (Internal Server Error) | Database or server error                                 |

- Example Response (200 OK):
    ```json
    {
      "message": "User ID retrieved successfully",
      "data": {
        "id": "60c72b2f9b1d4c3a2e5f8b4c",
        "username": "johndoe"
      }
    }
    ```

### Get User

- This endpoint allows retrieval of a single user's data from the database using the user's ID.

  > :bulb: The user ID refers to the MongoDB Object ID, a unique identifier automatically generated by MongoDB for each document in a collection.

- HTTP Method: `GET`

- Endpoint: http://localhost:3001/users/{userId}

- Parameters
    - Required: `userId` path parameter
    - Example: `http://localhost:3001/users/60c72b2f9b1d4c3a2e5f8b4c`

- <a name="auth-header">Authentication</a>
  
    - Required: Valid authentication cookies (automatically managed by browser)
    
    - Explanation: This endpoint requires the client to include JWT cookies in the HTTP request for authentication and authorization. These cookies are automatically set during the authentication process (i.e., login) and contain access tokens with information about the user's identity. The server verifies these cookies to ensure that the client is authorized to access the data.
    
    - Cookie Details:
        - `accessToken`: httpOnly cookie containing the JWT access token (15 minutes TTL)
        - `refreshToken`: httpOnly cookie containing the refresh token (7 days TTL)
        - Cookies are automatically sent by the browser with `credentials: 'include'`
    
    - Auth Rules:
    
        - Admin users: Can retrieve any user's data. The server verifies the user associated with the JWT token is an admin user and allows access to the requested user's data.
          
        - Non-admin users: Can only retrieve their own data. The server checks if the user ID in the request URL matches the ID of the user associated with the JWT token. If it matches, the server returns the user's own data.
    
- Responses:

    | Response Code               | Explanation                                              |
    |-----------------------------|----------------------------------------------------------|
    | 200 (OK)                    | Success, user data returned                              |
    | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT         |
    | 403 (Forbidden)             | Access denied for non-admin users accessing others' data |
    | 404 (Not Found)             | User with the specified ID not found                     |
    | 500 (Internal Server Error) | Database or server error                                 |

### Get All Users

- This endpoint allows retrieval of all users' data from the database.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/users
- Authentication
    - Required: Valid authentication cookies (automatically managed by browser)
    - Auth Rules:

        - Admin users: Can retrieve all users' data. The server verifies the user associated with the JWT token is an admin user and allows access to all users' data.
          
        - Non-admin users: Not allowed access.

- Responses:

    | Response Code               | Explanation                                      |
    |-----------------------------|--------------------------------------------------|
    | 200 (OK)                    | Success, all user data returned                  |
    | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT |
    | 403 (Forbidden)             | Access denied for non-admin users                |
    | 500 (Internal Server Error) | Database or server error                         |

### Update User

- This endpoint allows updating a user and their related data in the database using the user's ID.

- HTTP Method: `PATCH`

- Endpoint: http://localhost:3001/users/{userId}

- Parameters
  - Required: `userId` path parameter

- Body
  - At least one of the following fields is required: `username` (string), `email` (string), `password` (string)

    ```json
    {
      "username": "SampleUserName",
      "email": "sample@gmail.com",
      "password": "SecurePassword"
    }
    ```

- Authentication
    - Required: Valid authentication cookies (automatically managed by browser)
    - Auth Rules:

        - Admin users: Can update any user's data. The server verifies the user associated with the JWT token is an admin user and allows the update of requested user's data.
          
        - Non-admin users: Can only update their own data. The server checks if the user ID in the request URL matches the ID of the user associated with the JWT token. If it matches, the server updates the user's own data.

- Responses:

    | Response Code               | Explanation                                             |
    |-----------------------------|---------------------------------------------------------|
    | 200 (OK)                    | User updated successfully, updated user data returned   |
    | 400 (Bad Request)           | Missing fields                                          |
    | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT        |
    | 403 (Forbidden)             | Access denied for non-admin users updating others' data |
    | 404 (Not Found)             | User with the specified ID not found                    |
    | 409 (Conflict)              | Duplicate username or email encountered                 |
    | 500 (Internal Server Error) | Database or server error                                |

### Update User Privilege

- This endpoint allows updating a userâ€™s privilege, i.e., promoting or demoting them from admin status.

- HTTP Method: `PATCH`

- Endpoint: http://localhost:3001/users/{userId}

- Parameters
  - Required: `userId` path parameter

- Body
  - Required: `isAdmin` (boolean)

    ```json
    {
      "isAdmin": true
    }
    ```

- Authentication
    - Required: Valid authentication cookies (automatically managed by browser)
    - Auth Rules:

        - Admin users: Can update any user's privilege. The server verifies the user associated with the JWT token is an admin user and allows the privilege update.
        - Non-admin users: Not allowed access.

> :bulb: You may need to manually assign admin status to the first user by directly editing the database document before using this endpoint.

- Responses:

    | Response Code               | Explanation                                                     |
    |-----------------------------|-----------------------------------------------------------------|
    | 200 (OK)                    | User privilege updated successfully, updated user data returned |
    | 400 (Bad Request)           | Missing fields                                                  |
    | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT                |
    | 403 (Forbidden)             | Access denied for non-admin users                               |
    | 404 (Not Found)             | User with the specified ID not found                            |
    | 500 (Internal Server Error) | Database or server error                                        |

### Delete User

- This endpoint allows deletion of a user and their related data from the database using the user's ID.
- HTTP Method: `DELETE`
- Endpoint: http://localhost:3001/users/{userId}
- Parameters

  - Required: `userId` path parameter
- Authentication

  - Required: Valid authentication cookies (automatically managed by browser)

  - Auth Rules:

    - Admin users: Can delete any user's data. The server verifies the user associated with the JWT token is an admin user and allows the deletion of requested user's data.

    - Non-admin users: Can only delete their own data. The server checks if the user ID in the request URL matches the ID of the user associated with the JWT token. If it matches, the server deletes the user's own data.
- Responses:

    | Response Code               | Explanation                                             |
    |-----------------------------|---------------------------------------------------------|
    | 200 (OK)                    | User deleted successfully                               |
    | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT        |
    | 403 (Forbidden)             | Access denied for non-admin users deleting others' data |
    | 404 (Not Found)             | User with the specified ID not found                    |
    | 500 (Internal Server Error) | Database or server error                                |

### Login

- This endpoint allows a user to authenticate with an email and password and returns authentication cookies. The access token cookie is valid for 15 minutes and the refresh token cookie is valid for 7 days. These cookies are automatically included in subsequent requests to access protected resources.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/login
- Body
  - Required: `email` (string), `password` (string)

    ```json
    {
      "email": "sample@gmail.com",
      "password": "SecurePassword"
    }
    ```

- Response: Sets httpOnly cookies (`accessToken` and `refreshToken`) and returns user data

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | Login successful, authentication cookies set, user data returned |
    | 400 (Bad Request)           | Missing fields                                     |
    | 401 (Unauthorized)          | Incorrect email or password                        |
    | 500 (Internal Server Error) | Database or server error                           |

### Verify Token

- This endpoint allows one to verify authentication cookies and retrieve the user's data associated with the access token.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/auth/verify-token
- Authentication
  - Required: Valid authentication cookies (automatically sent by browser)

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | Token verified, authenticated user's data returned |
    | 401 (Unauthorized)          | Missing/invalid/expired JWT                        |
    | 500 (Internal Server Error) | Database or server error                           |

### Refresh Token

- This endpoint allows refreshing an expired access token using a valid refresh token stored in httpOnly cookies.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/refresh
- Headers
  - Required: Cookie with valid refresh token (automatically sent by browser)

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | New access token generated and returned           |
    | 401 (Unauthorized)          | Missing/invalid/expired refresh token             |
    | 500 (Internal Server Error) | Database or server error                           |

### Logout

- This endpoint allows a user to securely logout by removing their access token from the whitelist and clearing authentication cookies.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/logout
- Authentication
  - Required: Valid authentication cookies (automatically sent by browser)

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | Logout successful, tokens invalidated and cookies cleared |
    | 401 (Unauthorized)          | Missing/invalid JWT                                |
    | 500 (Internal Server Error) | Database or server error                           |

### Reset Token TTL

- This endpoint allows authenticated users to reset their access token's TTL (Time To Live) back to the full 15 minutes. This is useful for keeping active users logged in without requiring a full token refresh.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/reset-ttl
- Body: No body required

- Authentication
  - Required: Valid authentication cookies (automatically sent by browser)

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | Token TTL reset successfully                       |
    | 401 (Unauthorized)          | Missing/invalid/expired JWT                        |
    | 500 (Internal Server Error) | Database or server error                           |

- Example Response (200 OK):
    ```json
    {
      "message": "Token TTL reset successfully",
      "data": {
        "newExpiryInSeconds": 900,
        "message": "Session reset to full 15 minutes"
      }
    }
    ```

## Email Verification (OTP)

### Send Verification OTP

- This endpoint generates and sends a 6-digit OTP (One-Time Password) to the authenticated user's email address for account verification. Users must verify their email before gaining full access to protected features.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/send-otp
- Authentication
  - Required: Valid authentication cookies (automatically sent by browser)
  - Note: User must be logged in but may not be verified yet

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | OTP sent successfully to user's email             |
    | 400 (Bad Request)           | User already verified or OTP recently sent        |
    | 401 (Unauthorized)          | Missing/invalid/expired JWT                        |
    | 500 (Internal Server Error) | Email service error or server error               |

- Example Response (200 OK):
    ```json
    {
      "message": "OTP sent successfully to your email address.",
      "data": {
        "email": "user@example.com",
        "expiryMinutes": 5
      }
    }
    ```

### Verify OTP

- This endpoint verifies the 6-digit OTP sent to the user's email and marks their account as verified.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/verify-otp
- Authentication
  - Required: Valid authentication cookies (automatically sent by browser)

- Body
  - Required: `otp` (string) - 6-digit verification code

    ```json
    {
      "otp": "123456"
    }
    ```

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | Email verified successfully                        |
    | 400 (Bad Request)           | Invalid/expired OTP or user already verified      |
    | 401 (Unauthorized)          | Missing/invalid/expired JWT                        |
    | 500 (Internal Server Error) | Database or server error                           |

- Example Response (200 OK):
    ```json
    {
      "message": "Email verified successfully",
      "data": {
        "user": {
          "id": "user_id",
          "username": "username",
          "email": "user@example.com",
          "isVerified": true
        },
        "verifiedAt": "2024-03-20T10:30:00.000Z"
      }
    }
    ```

### Check Verification Status

- This endpoint allows authenticated users to check their current email verification status and OTP information.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/auth/verification-status
- Authentication
  - Required: Valid authentication cookies (automatically sent by browser)

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | Verification status retrieved successfully         |
    | 401 (Unauthorized)          | Missing/invalid/expired JWT                        |
    | 500 (Internal Server Error) | Database or server error                           |

- Example Response (200 OK):
    ```json
    {
      "message": "Verification status retrieved",
      "data": {
        "email": "user@example.com",
        "username": "username",
        "isVerified": false,
        "hasActivePendingOTP": true,
        "otpExpiresIn": 240,
        "canSendOTP": false
      }
    }
    ```

### Get User Profile

- This endpoint allows authenticated users to retrieve their own profile information.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/users/profile
- Authentication
  - Required: Valid authentication cookies (automatically sent by browser)

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | User profile data returned                         |
    | 401 (Unauthorized)          | Missing/invalid/expired JWT                        |
    | 500 (Internal Server Error) | Database or server error                           |

### Update User Privilege

- This endpoint allows admin users to update another user's privilege level (admin/non-admin).
- HTTP Method: `PATCH`
- Endpoint: http://localhost:3001/users/{userId}/privilege
- Parameters
  - Required: `userId` path parameter

- Body
  - Required: `isAdmin` (boolean)

    ```json
    {
      "isAdmin": true
    }
    ```

- Authentication
  - Required: Valid authentication cookies (automatically sent by browser)
  - Auth Rules: Admin users only

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | User privilege updated successfully                |
    | 400 (Bad Request)           | Missing or invalid isAdmin field                   |
    | 401 (Unauthorized)          | Missing/invalid/expired JWT                        |
    | 403 (Forbidden)             | Access denied for non-admin users                 |
    | 404 (Not Found)             | User with specified ID not found                   |
    | 500 (Internal Server Error) | Database or server error                           |

## Forgot Password (OTP-based)

The forgot password feature allows users to securely reset their password by verifying their email through an OTP (One-Time Password).

### Initiate Password Reset

- This endpoint sends a 6-digit OTP to the user's email for password reset.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/password-reset/initiate
- Body
  - Required: `email` (string)

    ```json
    {
      "email": "sample@gmail.com"
    }
    ```

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | OTP sent successfully (always returns 200 for security) |
    | 400 (Bad Request)           | Invalid email format or OTP cooldown active        |
    | 500 (Internal Server Error) | Email service error or server error               |

### Verify Password Reset OTP

- This endpoint verifies the OTP without resetting the password (optional step for multi-step UIs).
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/password-reset/verify
- Body
  - Required: `email` (string), `otp` (string)

    ```json
    {
      "email": "sample@gmail.com",
      "otp": "123456"
    }
    ```

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | OTP verified successfully                          |
    | 400 (Bad Request)           | Invalid/expired OTP                                |
    | 404 (Not Found)             | User not found                                     |
    | 500 (Internal Server Error) | Database or server error                           |

### Reset Password

- This endpoint resets the user's password after OTP verification.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/password-reset/reset
- Body
  - Required: `email` (string), `otp` (string), `newPassword` (string)

    ```json
    {
      "email": "sample@gmail.com",
      "otp": "123456",
      "newPassword": "NewSecurePassword123!"
    }
    ```

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | Password reset successfully                        |
    | 400 (Bad Request)           | Invalid OTP, password validation failed            |
    | 404 (Not Found)             | User not found                                     |
    | 500 (Internal Server Error) | Database or server error                           |

### Resend Password Reset OTP

- This endpoint resends the password reset OTP to the user's email.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/password-reset/resend-otp
- Body
  - Required: `email` (string)

    ```json
    {
      "email": "sample@gmail.com"
    }
    ```

- Responses:

    | Response Code               | Explanation                                        |
    |-----------------------------|----------------------------------------------------|
    | 200 (OK)                    | OTP resent successfully (always returns 200 for security) |
    | 400 (Bad Request)           | OTP cooldown active                                |
    | 500 (Internal Server Error) | Email service error or server error               |

For detailed API documentation including request/response examples and error codes, see [FORGOT_PASSWORD_API.md](./FORGOT_PASSWORD_API.md).

## API Endpoints Summary

### Authentication Routes (`/auth`)
- `POST /auth/login` - User login
- `GET /auth/verify-token` - Verify JWT token
- `POST /auth/refresh` - Refresh access token
- `POST /auth/logout` - User logout
- `POST /auth/reset-ttl` - Reset token TTL to full duration
- `POST /auth/send-otp` - Send email verification OTP
- `POST /auth/verify-otp` - Verify email with OTP code
- `GET /auth/verification-status` - Check email verification status
- `POST /auth/password-reset/initiate` - Initiate password reset (sends OTP)
- `POST /auth/password-reset/verify` - Verify password reset OTP
- `POST /auth/password-reset/reset` - Reset password with OTP
- `POST /auth/password-reset/resend-otp` - Resend password reset OTP

### User Routes (`/users`)
- `POST /users` - Create new user (registration)
- `GET /users/profile` - Get current user's profile
- `GET /users/:id` - Get specific user (admin only)
- `PATCH /users/:id` - Update user
- `PATCH /users/:id/privilege` - Update user privilege (admin only)
- `DELETE /users/:id` - Delete user (admin only)

## Security Features

- **Email Verification**: OTP-based email verification for account security
- **OTP System**: 6-digit codes with 5-minute expiry and rate limiting
- **Cookie-Based Authentication**: httpOnly cookies for secure token storage
- **JWT Access Tokens**: 15-minute expiry with automatic refresh
- **Refresh Tokens**: 7-day expiry stored in secure httpOnly cookies
- **Token Whitelisting**: Redis-based token validation with automatic cleanup
- **Single Session Enforcement**: One active session per user
- **TTL Reset**: Reset token expiration for active users
- **Password Security**: Argon2id hashing with configurable parameters
- **Input Validation**: Comprehensive validation middleware
- **Admin Authorization**: Role-based access control
- **Rate Limiting**: Configurable request rate limits (10 auth attempts per 15 minutes)
- **XSS Protection**: httpOnly cookies prevent JavaScript access
- **CSRF Protection**: SameSite cookie configuration
- **Email Service**: Secure SMTP integration with timeout protection